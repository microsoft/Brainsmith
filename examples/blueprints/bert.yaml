# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: "BERT"
description: "BERT Transformer encoder model (no initial embedding)"

clock_ns: 5.0                       # Target clock period in nanoseconds
output: "bitfile"                   # estimates | rtl | bitfile
board: "V80"                        # Target FPGA board

design_space:
  kernels:
    # Computational Kernels
    - LayerNorm
    - ElementwiseBinaryOp
    - Shuffle
    - Crop
    - Lookup
    - Softmax
    - Thresholding
    - finn:MVAU
    # Infrastructure Kernels
    - DuplicateStreams

  steps:
    - "qonnx_to_finn"
    - "bert_streamlining"
    - "normalize_dataflow_layouts"         # Normalize tensors to NHWC layout
    - "infer_computational_kernels"        # Infer pattern-based kernels (MVAU, LayerNorm, etc.)
    - "insert_infrastructure_kernels"      # Insert topology-based kernels (DuplicateStreams, etc.)
    - "specialize_kernel_backends"         # Select HLS/RTL backends + create dataflow partition
    - "loop_rolling"
    - "brainsmith:target_fps_parallelization"
    - "apply_parallelization_config"
    - "minimize_bit_width"                 # CRITICAL: Must run BEFORE loop_rolling so RoundAndClipThresholds can access initializers
    - "transpose_decomposition"
    - "generate_estimate_reports"
    - "hw_codegen"
    - "hw_ipgen"
    - "set_fifo_depths"
    - "create_stitched_ip"
    - "measure_rtlsim_performance"
