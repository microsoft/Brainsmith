// Auto-generated by Brainsmith Kernel Integrator for {{ kernel_metadata.name }}
// Generated from: {{ kernel_metadata.source_file }}

module {{ kernel_metadata.name }}_wrapper #(
{%- set has_general = kernel_metadata.parameters|length > 0 %}
{%- set has_axilite = kernel_metadata.has_axilite_enable_params %}
{%- set has_interface = kernel_metadata.has_interface_params %}

{% if has_general %}
    // General algorithm parameters
{% for param in kernel_metadata.parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not loop.last %},
{% endif %}{% endfor %}{% if has_axilite or has_interface %},{% endif %}
{% endif %}
{%- if has_axilite %}

    // AXI-Lite configuration parameter
{% for interface in kernel_metadata.config %}
{% if interface.enable_param %}
    parameter {{ interface.enable_param.name }} = {{ interface.enable_param.template_param_name }}{% if has_interface %},{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{%- if has_interface %}
{#- Collect datatype parameters from config interfaces -#}
{% for interface in kernel_metadata.config %}
{% if interface.dtype_params and interface.dtype_params.has_any() %}

    // {{ interface.name }} datatype
{% if interface.dtype_params.width %}
    parameter {{ interface.dtype_params.width.name }} = {{ interface.dtype_params.width.template_param_name }}{% if not loop.last or kernel_metadata.stream_interfaces %},{% endif %}
{% endif %}
{% endif %}
{% endfor %}

{#- Interface parameters from stream interfaces -#}
{% for interface in kernel_metadata.stream_interfaces %}
{% if interface.has_parameters() %}

    // {{ interface.name }} interface parameters
{% for param in interface.get_all_params() %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not loop.last %},
{% endif %}{% endfor %}{% if not loop.last %},{% endif %}
{% endif %}
{% endfor %}
{% endif %}
) (
    // Global Control
    input wire ap_clk,
    input wire ap_rst_n{% if kernel_metadata.stream_interfaces or kernel_metadata.config %},{% endif %}

{#- Input interfaces -#}
{%- for interface in kernel_metadata.inputs %}

    // {{ interface.compiler_name }}: {% if interface.is_weight %}WEIGHT{% else %}INPUT{% endif %} interface (RTL: {{ interface.name }})
    input wire [${{ interface.name.upper() }}_STREAM_WIDTH$-1:0] {{ interface.compiler_name }}_TDATA,
    input wire {{ interface.compiler_name }}_TVALID,
    output wire {{ interface.compiler_name }}_TREADY,
{%- if interface.tlast %}
    input wire {{ interface.compiler_name }}_TLAST,
{%- endif %}
{%- endfor %}

{#- Output interfaces -#}
{%- for interface in kernel_metadata.outputs %}

    // {{ interface.compiler_name }}: OUTPUT interface (RTL: {{ interface.name }})
    output wire [${{ interface.name.upper() }}_STREAM_WIDTH$-1:0] {{ interface.compiler_name }}_TDATA,
    output wire {{ interface.compiler_name }}_TVALID,
    input wire {{ interface.compiler_name }}_TREADY,
{%- if interface.tlast %}
    output wire {{ interface.compiler_name }}_TLAST,
{%- endif %}
{%- endfor %}

{#- Config interfaces (AXI-Lite) -#}
{%- for interface in kernel_metadata.config %}

    // {{ interface.compiler_name }}: CONFIG interface (AXI-Lite, RTL: {{ interface.name }})
{%- if interface.has_write %}

    // Write Address Channel
    input wire {{ interface.compiler_name }}_AWVALID,
    output wire {{ interface.compiler_name }}_AWREADY,
    input wire [31:0] {{ interface.compiler_name }}_AWADDR,
{%- if interface.awprot %}
    input wire [2:0] {{ interface.compiler_name }}_AWPROT,
{%- endif %}

    // Write Data Channel
    input wire {{ interface.compiler_name }}_WVALID,
    output wire {{ interface.compiler_name }}_WREADY,
    input wire [31:0] {{ interface.compiler_name }}_WDATA,
    input wire [3:0] {{ interface.compiler_name }}_WSTRB,

    // Write Response Channel
    output wire {{ interface.compiler_name }}_BVALID,
    input wire {{ interface.compiler_name }}_BREADY,
    output wire [1:0] {{ interface.compiler_name }}_BRESP,
{%- endif %}
{%- if interface.has_read %}

    // Read Address Channel
    input wire {{ interface.compiler_name }}_ARVALID,
    output wire {{ interface.compiler_name }}_ARREADY,
    input wire [31:0] {{ interface.compiler_name }}_ARADDR,
{%- if interface.arprot %}
    input wire [2:0] {{ interface.compiler_name }}_ARPROT,
{%- endif %}

    // Read Data Channel
    output wire {{ interface.compiler_name }}_RVALID,
    input wire {{ interface.compiler_name }}_RREADY,
    output wire [31:0] {{ interface.compiler_name }}_RDATA,
    output wire [1:0] {{ interface.compiler_name }}_RRESP{% if not loop.last %},{% endif %}
{%- endif %}
{%- endfor %}
);

    // Instantiate the wrapped kernel
    {{ kernel_metadata.name }} #(
{%- if has_general %}

        // General algorithm parameters
{% for param in kernel_metadata.parameters %}
        .{{ param.name }}({{ param.name }}){% if not loop.last %},
{% endif %}{% endfor %}{% if has_axilite or has_interface %},{% endif %}
{% endif %}
{%- if has_axilite %}

        // AXI-Lite configuration parameters
{% for interface in kernel_metadata.config %}
{% if interface.enable_param %}
        .{{ interface.enable_param.name }}({{ interface.enable_param.name }}){% if has_interface %},{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{%- if has_interface %}
{#- Config interface datatype parameters -#}
{% for interface in kernel_metadata.config %}
{% if interface.dtype_params and interface.dtype_params.has_any() %}

        // {{ interface.name }} datatype
{% if interface.dtype_params.width %}
        .{{ interface.dtype_params.width.name }}({{ interface.dtype_params.width.name }}){% if not loop.last or kernel_metadata.stream_interfaces %},{% endif %}
{% endif %}
{% endif %}
{% endfor %}

{#- Stream interface parameters -#}
{% for interface in kernel_metadata.stream_interfaces %}
{% if interface.has_parameters() %}

        // {{ interface.name }} interface parameters
{% for param in interface.get_all_params() %}
        .{{ param.name }}({{ param.name }}){% if not loop.last %},
{% endif %}{% endfor %}{% if not loop.last %},{% endif %}
{% endif %}
{% endfor %}
{% endif %}
    ) {{ kernel_metadata.name }}_inst (
        // Global control
        .{{ kernel_metadata.control.clk.name }}(ap_clk),
        .{{ kernel_metadata.control.rst_n.name }}(ap_rst_n){% if kernel_metadata.stream_interfaces or kernel_metadata.config %},{% endif %}

{#- Connect input interfaces -#}
{%- for interface in kernel_metadata.inputs %}

        // {{ interface.name }} connections (from {{ interface.compiler_name }})
        .{{ interface.tdata.name }}({{ interface.compiler_name }}_TDATA),
        .{{ interface.tvalid.name }}({{ interface.compiler_name }}_TVALID),
        .{{ interface.tready.name }}({{ interface.compiler_name }}_TREADY){% if interface.tlast %},
        .{{ interface.tlast.name }}({{ interface.compiler_name }}_TLAST){% endif %}{% if not loop.last or kernel_metadata.outputs or kernel_metadata.config %},{% endif %}
{%- endfor %}

{#- Connect output interfaces -#}
{%- for interface in kernel_metadata.outputs %}

        // {{ interface.name }} connections (to {{ interface.compiler_name }})  
        .{{ interface.tdata.name }}({{ interface.compiler_name }}_TDATA),
        .{{ interface.tvalid.name }}({{ interface.compiler_name }}_TVALID),
        .{{ interface.tready.name }}({{ interface.compiler_name }}_TREADY){% if interface.tlast %},
        .{{ interface.tlast.name }}({{ interface.compiler_name }}_TLAST){% endif %}{% if not loop.last or kernel_metadata.config %},{% endif %}
{%- endfor %}

{#- Connect config interfaces -#}
{%- for interface in kernel_metadata.config %}

        // {{ interface.name }} connections (from/to {{ interface.compiler_name }})
{%- if interface.has_write %}

        .{{ interface.awvalid.name }}({{ interface.compiler_name }}_AWVALID),
        .{{ interface.awready.name }}({{ interface.compiler_name }}_AWREADY),
        .{{ interface.awaddr.name }}({{ interface.compiler_name }}_AWADDR),
{% if interface.awprot %}
        .{{ interface.awprot.name }}({{ interface.compiler_name }}_AWPROT),
{% endif %}
        .{{ interface.wvalid.name }}({{ interface.compiler_name }}_WVALID),
        .{{ interface.wready.name }}({{ interface.compiler_name }}_WREADY),
        .{{ interface.wdata.name }}({{ interface.compiler_name }}_WDATA),
        .{{ interface.wstrb.name }}({{ interface.compiler_name }}_WSTRB),
        .{{ interface.bvalid.name }}({{ interface.compiler_name }}_BVALID),
        .{{ interface.bready.name }}({{ interface.compiler_name }}_BREADY),
        .{{ interface.bresp.name }}({{ interface.compiler_name }}_BRESP){% if interface.has_read %},{% endif %}
{%- endif %}
{%- if interface.has_read %}

        .{{ interface.arvalid.name }}({{ interface.compiler_name }}_ARVALID),
        .{{ interface.arready.name }}({{ interface.compiler_name }}_ARREADY),
        .{{ interface.araddr.name }}({{ interface.compiler_name }}_ARADDR),
{% if interface.arprot %}
        .{{ interface.arprot.name }}({{ interface.compiler_name }}_ARPROT),
{% endif %}
        .{{ interface.rvalid.name }}({{ interface.compiler_name }}_RVALID),
        .{{ interface.rready.name }}({{ interface.compiler_name }}_RREADY),
        .{{ interface.rdata.name }}({{ interface.compiler_name }}_RDATA),
        .{{ interface.rresp.name }}({{ interface.compiler_name }}_RRESP){% if not loop.last %},{% endif %}
{%- endif %}
{%- endfor %}
    );

endmodule // {{ kernel_metadata.name }}_wrapper