{#-
Minimalist RTL Wrapper Template V2 - Direct Access

This template generates clean Verilog wrappers with direct metadata access.
-#}
// Auto-generated by Brainsmith Kernel Integrator
// Generated from: {{ kernel_metadata.source_file }}
// Date: {{ generation_timestamp }}

module {{ kernel_metadata.name }}_wrapper #(
{%- set cat_params = categorized_parameters -%}
{%- set all_param_sections = [] -%}
{%- if cat_params.general_parameters -%}{%- set _ = all_param_sections.append('general') -%}{%- endif -%}
{%- if cat_params.axilite_parameters -%}{%- set _ = all_param_sections.append('axilite') -%}{%- endif -%}
{%- if cat_params.internal_datatype_groups -%}{%- set _ = all_param_sections.append('internal') -%}{%- endif -%}
{%- if cat_params.interface_parameter_groups -%}{%- set _ = all_param_sections.append('interface') -%}{%- endif -%}

{%- if cat_params.general_parameters %}
    // General algorithm parameters
{% for param in cat_params.general_parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not (loop.last and 'general' == all_param_sections[-1]) %},
{% endif %}{% endfor %}
{%- endif %}

{%- if cat_params.axilite_parameters %}
    // AXI-Lite configuration parameters
{% for param in cat_params.axilite_parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not (loop.last and 'axilite' == all_param_sections[-1]) %},
{% endif %}{% endfor %}
{%- endif %}

{%- if cat_params.internal_datatype_groups %}
{% set internal_datatype_names = cat_params.internal_datatype_groups.keys() | list %}
{% for datatype_name in internal_datatype_names %}
    // {{ datatype_name }} datatype
{% set params = cat_params.internal_datatype_groups[datatype_name] -%}
{% for param in params %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not (loop.last and datatype_name == internal_datatype_names[-1] and 'internal' == all_param_sections[-1]) %},
{% endif %}{% endfor %}
{% endfor %}
{%- endif %}

{%- if cat_params.interface_parameter_groups %}
{% for group in cat_params.interface_parameter_groups %}
    // {{ group.interface.name }} interface parameters
{% for param in group.parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not (loop.last and group == cat_params.interface_parameter_groups[-1] and 'interface' == all_param_sections[-1]) %},
{% endif %}{% endfor %}
{% endfor %}
{%- endif %}
) (
    // Control signals
    input wire ap_clk,
    input wire ap_rst_n,
    input wire ap_start,
    output wire ap_done,
    output wire ap_idle,
    output wire ap_ready{% if kernel_metadata.input_interfaces|length + kernel_metadata.output_interfaces|length + kernel_metadata.weight_interfaces|length + kernel_metadata.config_interfaces|length > 0 %},{% endif %}

{%- set ns = namespace(first_interface=true) %}
{% for interface in kernel_metadata.input_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
    
    // {{ interface.name }} input stream
    input wire {{ interface.name }}_valid,
    output wire {{ interface.name }}_ready,
    input wire [{{ interface.name|upper }}_STREAM_WIDTH-1:0] {{ interface.name }}_data
{%- endfor %}

{% for interface in kernel_metadata.output_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
    
    // {{ interface.name }} output stream  
    output wire {{ interface.name }}_valid,
    input wire {{ interface.name }}_ready,
    output wire [{{ interface.name|upper }}_STREAM_WIDTH-1:0] {{ interface.name }}_data
{%- endfor %}

{% for interface in kernel_metadata.weight_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
    
    // {{ interface.name }} weight stream
    input wire {{ interface.name }}_valid,
    output wire {{ interface.name }}_ready,
    input wire [{{ interface.name|upper }}_STREAM_WIDTH-1:0] {{ interface.name }}_data
{%- endfor %}

{% for interface in kernel_metadata.config_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
    
    // {{ interface.name }} configuration
    input wire [{{ interface.name|upper }}_WIDTH-1:0] {{ interface.name }}_data
{%- endfor %}
);

    // Instantiate the top module
    {{ kernel_metadata.module_name }} #(
{%- set all_params = [] -%}
{%- if cat_params.general_parameters -%}{%- set _ = all_params.extend(cat_params.general_parameters) -%}{%- endif -%}
{%- if cat_params.axilite_parameters -%}{%- set _ = all_params.extend(cat_params.axilite_parameters) -%}{%- endif -%}
{%- if cat_params.internal_datatype_groups -%}
{%-   for params in cat_params.internal_datatype_groups.values() -%}
{%-     set _ = all_params.extend(params) -%}
{%-   endfor -%}
{%- endif -%}
{%- if cat_params.interface_parameter_groups -%}
{%-   for group in cat_params.interface_parameter_groups -%}
{%-     set _ = all_params.extend(group.parameters) -%}
{%-   endfor -%}
{%- endif -%}

{% for param in all_params %}
        .{{ param.name }}({{ param.name }}){% if not loop.last %},{% endif %}
{% endfor %}
    ) inst (
        // Control signals
        .ap_clk(ap_clk),
        .ap_rst_n(ap_rst_n),
        .ap_start(ap_start),
        .ap_done(ap_done),
        .ap_idle(ap_idle),
        .ap_ready(ap_ready){% if kernel_metadata.input_interfaces|length + kernel_metadata.output_interfaces|length + kernel_metadata.weight_interfaces|length + kernel_metadata.config_interfaces|length > 0 %},{% endif %}

{%- set ns = namespace(first_interface=true) %}
{% for interface in kernel_metadata.input_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
        
        // {{ interface.name }} connections
        .{{ interface.name }}_valid({{ interface.name }}_valid),
        .{{ interface.name }}_ready({{ interface.name }}_ready),
        .{{ interface.name }}_data({{ interface.name }}_data)
{%- endfor %}

{% for interface in kernel_metadata.output_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
        
        // {{ interface.name }} connections
        .{{ interface.name }}_valid({{ interface.name }}_valid),
        .{{ interface.name }}_ready({{ interface.name }}_ready),
        .{{ interface.name }}_data({{ interface.name }}_data)
{%- endfor %}

{% for interface in kernel_metadata.weight_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
        
        // {{ interface.name }} connections
        .{{ interface.name }}_valid({{ interface.name }}_valid),
        .{{ interface.name }}_ready({{ interface.name }}_ready),
        .{{ interface.name }}_data({{ interface.name }}_data)
{%- endfor %}

{% for interface in kernel_metadata.config_interfaces %}
{% if not ns.first_interface %},{% endif %}{% set ns.first_interface = false %}
        
        // {{ interface.name }} connections
        .{{ interface.name }}_data({{ interface.name }}_data)
{%- endfor %}
    );

endmodule