{# Jinja2 template for Verilog Wrapper #}
// Auto-generated by Brainsmith Hardware Kernel Generator
// Date: {{ generation_timestamp }} {# Use pre-formatted timestamp #}

module {{ kernel.name }}_wrapper #(
    // Parameters from original module
{%- for param in kernel.parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not loop.last %},{% endif %}
{%- endfor %}
) (
    // Ports grouped by interface

    // --- Global Control ---
{%- for interface in interfaces.values() if interface.type == InterfaceType.GLOBAL_CONTROL %} {# Iterate over values, use interface.type #}
{%-   for port_key, port in interface.ports.items() %}
    {{ port.direction.value }} {{ port.name }}{% if not loop.last or interfaces.values() | selectattr('type', 'ne', InterfaceType.GLOBAL_CONTROL) | list %},{% endif %} {# Iterate over values, use interface.type #}
{%-   endfor %}
{%- endfor %}

    // --- AXI-Stream Interfaces ---
{%- set stream_interfaces = interfaces.values() | selectattr('type', 'eq', InterfaceType.AXI_STREAM) | list %}
{%- for interface in stream_interfaces %} {# Outer loop #}
{%-   set outer_loop_stream = loop %} {# Assign outer loop context #}
{%-   for port_key, port in interface.ports.items() %} {# Inner loop #}
{%-     set wrapper_port_name = interface.name + '_' + port_key %}
    {# Build line parts explicitly #}
{%-     set line_parts = [port.direction.value] %}
{%-     set width_str = "" %}
{%-     if port_key == 'TDATA' and 'data_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.data_width_expr ~ "]" %}
{%-     elif port_key == 'TKEEP' and 'keep_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.keep_width_expr ~ "]" %}
{%-     elif port_key == 'TSTRB' and 'strb_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.strb_width_expr ~ "]" %}
{%-     endif %}
{%-     if width_str %}
{%-       do line_parts.append(width_str) %}
{%-     endif %}
{%-     do line_parts.append(wrapper_port_name) %}
    {# Join parts and conditionally add comma #}
{%-     set base_line = line_parts | join(" ") %}
{%-     set has_lite = interfaces.values() | selectattr('type', 'eq', InterfaceType.AXI_LITE) | list | length > 0 %}
{%-     set is_last_stream_port = loop.last %}
{%-     set is_last_stream_interface = outer_loop_stream.last %}
{%-     if not is_last_stream_port or not is_last_stream_interface or has_lite %}
{%-       set base_line = base_line + ',' %}
{%-     endif %}
    {{ base_line }} {# Print the final line string #}
{%-   endfor %} {# End inner loop #}
{%- endfor %} {# End outer loop #}

    // --- AXI-Lite Interface ---
{%- set lite_interfaces = interfaces.values() | selectattr('type', 'eq', InterfaceType.AXI_LITE) | list %}
{%- for interface in lite_interfaces %} {# Outer loop #}
{%-   set outer_loop_lite = loop %} {# Assign outer loop context #}
{%-   for port_key, port in interface.ports.items() %}
{%-     set wrapper_port_name = interface.name + '_' + port_key %}
    {# Build line parts explicitly #}
{%-     set line_parts = [port.direction.value] %}
{%-     set width_str = "" %}
{%-     if port_key in ['AWADDR', 'ARADDR'] and 'addr_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.addr_width_expr ~ "]" %}
{%-     elif port_key in ['WDATA', 'RDATA'] and 'data_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.data_width_expr ~ "]" %}
{%-     elif port_key == 'WSTRB' and 'strb_width_expr' in interface.metadata -%}
{%-       set width_str = "[" ~ interface.metadata.strb_width_expr ~ "]" %}
{%-     endif %}
{%-     if width_str %}
{%-       do line_parts.append(width_str) %}
{%-     endif %}
{%-     do line_parts.append(wrapper_port_name) %}
    {# Join parts and conditionally add comma #}
{%-     set base_line = line_parts | join(" ") %}
{%-     set is_last_lite_port = loop.last %}
{%-     set is_last_lite_interface = outer_loop_lite.last %}
{%-     if not is_last_lite_port or not is_last_lite_interface %}
{%-       set base_line = base_line + ',' %}
{%-     endif %}
    {{ base_line }} {# Print the final line string #}
{%-   endfor %}
{%- endfor %}
);

// Instantiate the wrapped kernel
{{ kernel.name }} #(
    // Pass parameters
{%- for param in kernel.parameters %}
    .{{ param.name }}( {{ param.template_param_name | default(param.name) }} ){% if not loop.last %},{% endif %} {# Use default filter #}
{%- endfor %}
) {{ kernel.instance_name | default(kernel.name + "_inst") }} (
    // Connect ports

    // --- Global Control ---
{%- for interface in interfaces.values() if interface.type == InterfaceType.GLOBAL_CONTROL %}
{%-   for port_key, port in interface.ports.items() %}
{%-     set internal_signal = "clk" if "clk" in port.name|lower else "rst_n" if "rst" in port.name|lower else port.name %}
{%-     set internal_port = "clk" if "clk" in port.name|lower else "rst_n" if "rst" in port.name|lower else port.name %}
    .{{ internal_signal }}( {{ internal_port }} ){%- if not loop.last or interfaces.values() | selectattr('type', 'ne', InterfaceType.GLOBAL_CONTROL) | list %},{%- endif %}
{%-   endfor %}
{%- endfor %}
    // --- AXI-Stream Interfaces ---
{%- set stream_interfaces = interfaces.values() | selectattr('type', 'eq', InterfaceType.AXI_STREAM) | list %}
{%- set lite_interfaces = interfaces.values() | selectattr('type', 'eq', InterfaceType.AXI_LITE) | list %}
{%- for interface in stream_interfaces %} {# Outer loop #}
{%-   set outer_loop_stream = loop %} {# Assign outer loop context #}
{%-   for port_key, port in interface.ports.items() %} {# Inner loop #}
{%-     set wrapper_port_name = interface.name + '_' + port_key %}
    .{{ port.name }}( {{ wrapper_port_name }} ){%- if not loop.last or not outer_loop_stream.last or lite_interfaces %},{%- endif %}
{%-   endfor %} {# End inner loop #}
{%- endfor %} {# End outer loop #}

    // --- AXI-Lite Interface ---
{%- for interface in lite_interfaces %} {# Outer loop #}
{%-   set outer_loop_lite = loop %} {# Assign outer loop context #}
{%-   for port_key, port in interface.ports.items() %}
{%-     set wrapper_port_name = interface.name + '_' + port_key %}
    .{{ port.name }}( {{ wrapper_port_name }} ){%- if not loop.last or not outer_loop_lite.last %},{%- endif %}
{%-   endfor %}
{%- endfor %}
);

endmodule
