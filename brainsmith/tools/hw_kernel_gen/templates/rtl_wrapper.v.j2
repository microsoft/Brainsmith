{# Jinja2 template for Verilog Wrapper #}
// Auto-generated by Brainsmith Hardware Kernel Generator
// Date: {{ generation_timestamp }}

module ${{ kernel.name | upper }}_WRAPPER_NAME$ #(
    // Parameters from original module{{"\n"}}
{%- for param in kernel.parameters %}
    parameter {{ param.name }} = {{ param.template_param_name }}{% if not loop.last %},{% endif %}{{"\n"}}
{%- endfor -%}
) (
{# --- Calculate total number of ports --- #}
{%- set total_ports = 0 %}
{%- for interface in interfaces_list %} {# Use pre-sorted list from context #}
{%-   set total_ports = total_ports + interface.ports | length %}
{%- endfor %}
{%- set port_counter = namespace(value=0) %} {# Use namespace for mutable counter #}
{# --- End calculation --- #}
{# --- Iterate over the pre-sorted list from context --- #}
{%- for interface in interfaces_list %}

    // --- {{ interface.type.value | replace('_', ' ') | title }} {% if interface.type != InterfaceType.GLOBAL_CONTROL %}({{ interface.name }}){% endif %} ---{{"\n"}}
    {%- set ports_list = interface.ports.values() | sort(attribute='name') %}
    {%- for port in ports_list %}{%-set port_counter.value = port_counter.value + 1 -%} {# Increment counter #}
    {{ port.direction.value }}{% if port.width and port.width != '1' %}[{{ port.width }}]{% endif %} {{ port.name }},{% if port_counter.value < total_ports %}{% endif %}{{"\n"}}
    {%- endfor -%} {# <<< Added whitespace control -%}, REMOVED extra newline >>> #}
{%- endfor %}
);

    // Instantiate the wrapped kernel
    {{ kernel.name }} #(
        // Pass parameters{{"\n"}}
    {%- for param in kernel.parameters %}
        .{{ param.name }}({{ param.name }}){% if not loop.last %},{% endif %}{{"\n"}}
    {%- endfor -%} {# <<< REMOVED extra newline here >>> #}
    ) {{ kernel.name }}_inst (
    {# --- Reset counter for instantiation --- #}
    {%- set port_counter.value = 0 %}
    {# --- End reset --- #}
    {# --- Iterate over the pre-sorted list again --- #}
    {%- for interface in interfaces_list %} {# Use pre-sorted list #}

        // --- {{ interface.type.value | replace('_', ' ') | title }} {% if interface.type != InterfaceType.GLOBAL_CONTROL %}({{ interface.name }}){% endif %} ---{{"\n"}}
        {%- set ports_list_inst = interface.ports.values() | sort(attribute='name') %}
        {%- for port in ports_list_inst %}
        {%- set port_counter.value = port_counter.value + 1 -%} {# Increment counter #}
        .{{ port.name }}({{ port.name }}){% if port_counter.value < total_ports %}{% endif %},{{"\n"}}
        {%- endfor -%} {# <<< Added whitespace control -%}, REMOVED extra newline >>> #}
    {%- endfor %}
    );

endmodule // ${{ kernel.name | upper }}_WRAPPER_NAME${{"\n"}}
