{#-
Enhanced RTL Wrapper Template (v2) for Phase 3
Generated RTL wrapper with Phase 2 parameter validation and enhanced interface handling.

Features:
- Validated parameter handling from Phase 2
- Enhanced interface connections with BDIM annotations
- Parameter range validation and error checking
- Clean module structure for FINN integration
-#}
`timescale 1ns / 1ps

//=============================================================================
// Auto-generated RTL wrapper for {{ kernel_name }}
// Generated from: {{ source_file }}
// Template: rtl_wrapper_v2.v.j2 (Phase 3 Enhanced)
// Generation time: {{ generation_timestamp }}
//
// Phase 2 Features:
// ✅ Validated parameter references in BDIM pragmas
// ✅ Runtime parameter extraction support
// ✅ Enhanced interface metadata with chunking strategies
//=============================================================================

module {{ kernel_name }}_wrapper #(
    // RTL Parameters with Phase 2 validation
    {% for param in parameter_definitions -%}
    parameter {{ param.name }} = {{ param.default_value if param.default_value is not none else 1 }}{{ "," if not loop.last else "" }}
    {%- if param.description %} // {{ param.description }}{% endif %}
    {% endfor %}
) (
    // Global control interface (required)
    input wire ap_clk,
    input wire ap_rst_n,
    
    // AXI-Stream interfaces with validated BDIM parameters
    {% for interface in interface_metadata -%}
    {% if interface.interface_type.name == 'INPUT' %}
    
    // {{ interface.name }}: INPUT interface
    // Validated BDIM shape: {{ interface.chunking_strategy.block_shape if interface.chunking_strategy else "default" }}
    // Interface type: {{ interface.interface_type.name }}
    input  wire [{{ interface.name }}_TDATA_WIDTH-1:0] {{ interface.name }}_TDATA,
    input  wire {{ interface.name }}_TVALID,
    output wire {{ interface.name }}_TREADY,
    {% elif interface.interface_type.name == 'OUTPUT' %}
    
    // {{ interface.name }}: OUTPUT interface  
    // Validated BDIM shape: {{ interface.chunking_strategy.block_shape if interface.chunking_strategy else "default" }}
    // Interface type: {{ interface.interface_type.name }}
    output wire [{{ interface.name }}_TDATA_WIDTH-1:0] {{ interface.name }}_TDATA,
    output wire {{ interface.name }}_TVALID,
    input  wire {{ interface.name }}_TREADY,
    {% elif interface.interface_type.name == 'WEIGHT' %}
    
    // {{ interface.name }}: WEIGHT interface
    // Validated BDIM shape: {{ interface.chunking_strategy.block_shape if interface.chunking_strategy else "default" }}
    // Interface type: {{ interface.interface_type.name }}
    input  wire [{{ interface.name }}_TDATA_WIDTH-1:0] {{ interface.name }}_TDATA,
    input  wire {{ interface.name }}_TVALID,
    output wire {{ interface.name }}_TREADY,
    {% endif -%}
    {% endfor %}
    
    // Additional control signals
    input  wire ap_start,
    output wire ap_done,
    output wire ap_idle,
    output wire ap_ready
);

//=============================================================================
// Parameter Validation (Phase 2 guaranteed valid parameters)
//=============================================================================

{% if required_attributes %}
// Validation for required parameters (no defaults)
{% for param in required_attributes %}
initial begin
    if ({{ param }} <= 0) begin
        $error("[%s:%0d] Parameter {{ param }} must be positive, got %0d", 
               `__FILE__, `__LINE__, {{ param }});
        $finish;
    end
end
{% endfor %}
{% endif %}

{% if whitelisted_defaults %}
// Validation for whitelisted parameters (with defaults)
{% for param_name, default_value in whitelisted_defaults.items() %}
initial begin
    if ({{ param_name }} <= 0) begin
        $error("[%s:%0d] Parameter {{ param_name }} must be positive, got %0d (default: {{ default_value }})", 
               `__FILE__, `__LINE__, {{ param_name }});
        $finish;
    end
end
{% endfor %}
{% endif %}

// Parameter consistency checks
initial begin
    {% for interface in interface_metadata -%}
    {% if interface.chunking_strategy and interface.chunking_strategy.block_shape -%}
    {% for shape_element in interface.chunking_strategy.block_shape -%}
    {% if shape_element != ':' and shape_element.isidentifier() %}
    // Validate {{ shape_element }} for {{ interface.name }} interface
    if ({{ shape_element }} <= 0) begin
        $error("[%s:%0d] BDIM parameter {{ shape_element }} for {{ interface.name }} must be positive, got %0d", 
               `__FILE__, `__LINE__, {{ shape_element }});
        $finish;
    end
    {% endif -%}
    {% endfor -%}
    {% endif -%}
    {% endfor %}
end

//=============================================================================
// Interface Width Calculations (Based on Validated BDIM)
//=============================================================================

{% for interface in interface_metadata -%}
{% if interface.interface_type.name in ['INPUT', 'OUTPUT', 'WEIGHT'] %}
// {{ interface.name }} width calculation
{% if interface.allowed_datatypes and interface.allowed_datatypes|length > 0 %}
{% set datatype = interface.allowed_datatypes[0] %}
localparam {{ interface.name }}_ELEMENT_WIDTH = {{ datatype.bit_width }};
{% else %}
localparam {{ interface.name }}_ELEMENT_WIDTH = 8; // Default bit width
{% endif %}

{% if interface.chunking_strategy and interface.chunking_strategy.block_shape %}
// BDIM-based width: {{ interface.chunking_strategy.block_shape }}
{% set width_expr = [] %}
{% for shape_element in interface.chunking_strategy.block_shape -%}
{% if shape_element == ':' %}
{% set _ = width_expr.append('1') %}
{% elif shape_element.isdigit() %}
{% set _ = width_expr.append(shape_element) %}
{% elif shape_element.isidentifier() %}
{% set _ = width_expr.append(shape_element) %}
{% endif -%}
{% endfor %}
localparam {{ interface.name }}_PARALLEL_ELEMENTS = {% if width_expr|length > 0 %}{{ " * ".join(width_expr) }}{% else %}1{% endif %};
{% else %}
localparam {{ interface.name }}_PARALLEL_ELEMENTS = 1; // No BDIM specified
{% endif %}

localparam {{ interface.name }}_TDATA_WIDTH = {{ interface.name }}_ELEMENT_WIDTH * {{ interface.name }}_PARALLEL_ELEMENTS;

{% endif -%}
{% endfor %}

//=============================================================================
// Module Instance with Validated Parameters
//=============================================================================

{{ kernel_name }} #(
    {% for param in parameter_definitions -%}
    .{{ param.name }}({{ param.name }}){{ "," if not loop.last else "" }}
    {% endfor %}
) dut_inst (
    // Global control
    .ap_clk(ap_clk),
    .ap_rst_n(ap_rst_n),
    .ap_start(ap_start),
    .ap_done(ap_done),
    .ap_idle(ap_idle),
    .ap_ready(ap_ready),
    
    // Data interfaces
    {% for interface in interface_metadata -%}
    {% if interface.interface_type.name in ['INPUT', 'OUTPUT', 'WEIGHT'] %}
    .{{ interface.name }}_TDATA({{ interface.name }}_TDATA),
    .{{ interface.name }}_TVALID({{ interface.name }}_TVALID),
    .{{ interface.name }}_TREADY({{ interface.name }}_TREADY){{ "," if not loop.last else "" }}
    {% endif -%}
    {% endfor %}
);

//=============================================================================
// Debug and Monitoring (for development/testing)
//=============================================================================

`ifdef DEBUG_{{ kernel_name | upper }}

// Parameter values at elaboration time
initial begin
    $display("=== {{ kernel_name }}_wrapper Parameter Values ===");
    {% for param in parameter_definitions %}
    $display("{{ param.name }} = %0d", {{ param.name }});
    {% endfor %}
    
    $display("=== Interface Widths ===");
    {% for interface in interface_metadata -%}
    {% if interface.interface_type.name in ['INPUT', 'OUTPUT', 'WEIGHT'] %}
    $display("{{ interface.name }}_TDATA_WIDTH = %0d", {{ interface.name }}_TDATA_WIDTH);
    {% endif -%}
    {% endfor %}
    $display("=======================================");
end

// Runtime monitoring
always @(posedge ap_clk) begin
    if (ap_start && ap_ready) begin
        $display("[%0t] {{ kernel_name }}: Starting operation", $time);
    end
    if (ap_done) begin
        $display("[%0t] {{ kernel_name }}: Operation complete", $time);
    end
end

`endif // DEBUG_{{ kernel_name | upper }}

//=============================================================================
// Assertions for Interface Protocol Validation
//=============================================================================

`ifdef ASSERT_ON

{% for interface in interface_metadata -%}
{% if interface.interface_type.name in ['INPUT', 'OUTPUT'] %}
// {{ interface.name }} AXI-Stream protocol assertions
property {{ interface.name }}_tvalid_stable;
    @(posedge ap_clk) disable iff (!ap_rst_n)
    {{ interface.name }}_TVALID && !{{ interface.name }}_TREADY |=> {{ interface.name }}_TVALID;
endproperty

assert property({{ interface.name }}_tvalid_stable) 
else $error("{{ interface.name }}_TVALID not stable when TREADY low");

property {{ interface.name }}_tdata_stable;
    @(posedge ap_clk) disable iff (!ap_rst_n)
    {{ interface.name }}_TVALID && !{{ interface.name }}_TREADY |=> $stable({{ interface.name }}_TDATA);
endproperty

assert property({{ interface.name }}_tdata_stable) 
else $error("{{ interface.name }}_TDATA changed when TVALID high and TREADY low");

{% endif -%}
{% endfor %}

`endif // ASSERT_ON

endmodule

//=============================================================================
// End of {{ kernel_name }}_wrapper
// Template: rtl_wrapper_v2.v.j2 (Phase 3 Enhanced)
//=============================================================================