############################################################################
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
#
# @author       Thomas Keller <thomaskeller@microsoft.com>
############################################################################

# Brainsmith Kernel Modeling Visual Guide

## System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Brainsmith Kernel Modeling System                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐         ┌─────────────────────┐                   │
│  │  Definition Layer   │         │    Model Layer      │                   │
│  │                     │         │                     │                   │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │                   │
│  │ │KernelDefinition │ │ creates │ │  KernelModel    │ │                   │
│  │ │                 │◄├─────────┤►│                 │ │                   │
│  │ └────────┬────────┘ │         │ └────────┬────────┘ │                   │
│  │          │          │         │          │          │                   │
│  │          │ has      │         │          │ has      │                   │
│  │          ▼          │         │          ▼          │                   │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │                   │
│  │ │InterfaceDefn[] │ │ creates │ │InterfaceModel[] │ │                   │
│  │ │                 │◄├─────────┤►│                 │ │                   │
│  │ └─────────────────┘ │         │ └─────────────────┘ │                   │
│  │                     │         │                     │                   │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │                   │
│  │ │ Relationships[] │ │validates│ │   Propagation   │ │                   │
│  │ │                 │◄├─────────┤►│     Engine      │ │                   │
│  │ └─────────────────┘ │         │ └─────────────────┘ │                   │
│  └─────────────────────┘         └─────────────────────┘                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Support Systems                              │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │   Tiling     │  │  Expression  │  │ Performance  │            │   │
│  │  │  Functions   │  │  Evaluator   │  │   Metrics    │            │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  │                                                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │    Type      │  │   Config     │  │  Validation  │            │   │
│  │  │   System     │  │   System     │  │   System     │            │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Interface Dimension Hierarchy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Interface Dimensions                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Tensor Dimensions (Full Data)                                              │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │                    [1024, 2048, 224, 224]                │               │
│  │                  (batch, channels, height, width)        │               │
│  └──────────────────────────┬──────────────────────────────┘               │
│                             │                                               │
│                             │ Block Dimension Expression                    │
│                             │ parameterized_tiles("N", "C", "H", "W")      │
│                             ▼                                               │
│  Block Dimensions (Tiling)                                                  │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │                      [1, 64, 14, 14]                     │               │
│  │                 (with params: C=64, H=14, W=14)         │               │
│  └──────────────────────────┬──────────────────────────────┘               │
│                             │                                               │
│                             │ iPar = 16                                     │
│                             ▼                                               │
│  Stream Dimensions (Parallelism)                                            │
│  ┌─────────────────────────────────────────────────────────┐               │
│  │                      [1, 16, 1, 1]                       │               │
│  │              (64 channels ÷ 16 parallel = 4)           │               │
│  └─────────────────────────────────────────────────────────┘               │
│                                                                             │
│  Execution:                                                                 │
│  • Total blocks: (1024÷1) × (2048÷64) × (224÷14) × (224÷14) = 1024×32×16×16│
│  • Parallel streams: 16                                                     │
│  • Blocks per stream: Total blocks ÷ 16                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Tiling Strategy Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Tiling Strategy Selection                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  InterfaceDefinition                                                        │
│  ┌─────────────────────┐                                                   │
│  │  block_dims_expr    │                                                   │
│  └──────────┬──────────┘                                                   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────┐     Expression?    ┌──────────────────────┐      │
│  │   Type Check        ├───────────────────►│  Expression Parser   │      │
│  └──────────┬──────────┘                    │  ["1", "C_TILE", ":"]│      │
│             │                                └──────────────────────┘      │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────┐     Function?      ┌──────────────────────┐      │
│  │   Type Check        ├───────────────────►│  Function Call       │      │
│  └──────────┬──────────┘                    │  adaptive_tiles()    │      │
│             │                                └──────────────────────┘      │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────┐     None?          ┌──────────────────────┐      │
│  │   Type Check        ├───────────────────►│  Default Strategy    │      │
│  └─────────────────────┘                    │  _default_chunking() │      │
│                                              └──────────────────────┘      │
│                                                                             │
│  All paths lead to:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                     derive_block_dims()                          │       │
│  │   Input: tensor_dims, parameters, config                        │       │
│  │   Output: concrete block dimensions                             │       │
│  └─────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Relationship System Visualization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MatMul Relationship Example                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Matrix Multiplication: C = A × B                                          │
│                                                                             │
│   ┌───────────────┐                          ┌───────────────┐             │
│   │   A [M, K]    │                          │   B [K, N]    │             │
│   │               │                          │               │             │
│   │  ┌─┬─┬─┬─┐   │                          │  ┌─┬─┬─┬─┐   │             │
│   │  ├─┼─┼─┼─┤ M │                          │  ├─┼─┼─┼─┤ K │             │
│   │  ├─┼─┼─┼─┤   │                          │  ├─┼─┼─┼─┤   │             │
│   │  └─┴─┴─┴─┘   │                          │  └─┴─┴─┴─┘   │             │
│   │      K        │                          │      N        │             │
│   └───────┬───────┘                          └───────┬───────┘             │
│           │                                          │                      │
│           │ EQUAL(dim=1→0)                          │                      │
│           └─────────────┬────────────────────────────┘                      │
│                         ▼                                                   │
│            Relationship Validation:                                         │
│            A.shape[1] == B.shape[0]  ✓                                    │
│                                                                             │
│   ┌───────────────┐      ┌──────────────────────────┐                     │
│   │   A [M, K]    │      │ Relationships:           │                     │
│   └───────┬───────┘      │                          │                     │
│           │              │ 1. A→B: EQUAL(1→0)       │                     │
│           │ EQUAL(0→0)   │ 2. A→C: EQUAL(0→0)       │                     │
│           ▼              │ 3. B→C: EQUAL(1→1)       │                     │
│   ┌───────────────┐      └──────────────────────────┘                     │
│   │   C [M, N]    │◄─────── EQUAL(1→1) ─────────┐                         │
│   │               │                              │                         │
│   │  ┌─┬─┬─┬─┐   │                              │                         │
│   │  ├─┼─┼─┼─┤ M │                      ┌───────┴───────┐                 │
│   │  ├─┼─┼─┼─┤   │                      │   B [K, N]    │                 │
│   │  └─┴─┴─┴─┘   │                      └───────────────┘                 │
│   │      N        │                                                        │
│   └───────────────┘                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Parallelism Propagation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Parallelism Propagation Algorithm                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Apply Initial Parallelism                                               │
│  ┌────────────────────┐                                                    │
│  │ apply_parallelism() │                                                    │
│  │ {"output": 16}      │                                                    │
│  └─────────┬──────────┘                                                    │
│            │                                                                │
│            ▼                                                                │
│  2. Set iPar on Target Interface                                            │
│  ┌────────────────────┐        ┌─────────────────────┐                    │
│  │ output.ipar = 16   │───────►│ Triggers cache      │                    │
│  │                    │        │ invalidation        │                    │
│  └─────────┬──────────┘        └─────────────────────┘                    │
│            │                                                                │
│            ▼                                                                │
│  3. Propagate Through Relationships                                         │
│  ┌────────────────────────────────────────────────────┐                    │
│  │ for rel in relationships:                          │                    │
│  │   if rel.type == EQUAL:                           │                    │
│  │     if source.ipar and not target.ipar:           │                    │
│  │       if can_propagate(source, target):           │                    │
│  │         target.ipar = source.ipar                 │                    │
│  └────────────────────────────────────────────────────┘                    │
│            │                                                                │
│            ▼                                                                │
│  4. Validation Check                                                        │
│  ┌────────────────────────────────────────────────────┐                    │
│  │ can_propagate():                                   │                    │
│  │ • Check dimension compatibility                    │                    │
│  │ • Verify iPar ≤ block_dim                        │                    │
│  │ • Ensure proper factorization                     │                    │
│  └────────────────────────────────────────────────────┘                    │
│            │                                                                │
│            ▼                                                                │
│  5. Update Stream Dimensions                                                │
│  ┌────────────────────────────────────────────────────┐                    │
│  │ Stream Dim Calculation:                            │                    │
│  │ • Find first divisible dimension                  │                    │
│  │ • block_dim[i] ÷ iPar = stream_dim[i]            │                    │
│  │ • Other dimensions = 1                            │                    │
│  └────────────────────────────────────────────────────┘                    │
│                                                                             │
│  Example:                                                                   │
│  Output: block=[64,128] → iPar=16 → stream=[16,1] (64÷16=4)               │
│  Input A: EQUAL(0→0) → iPar=16 → stream=[16,1]                            │
│  Input B: EQUAL(1→1) → iPar=16 → stream=[1,16] (128÷16=8)                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

## CSDF Support Illustration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Cyclo-Static Dataflow (CSDF) Support                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase-Dependent Block Dimensions                                           │
│                                                                             │
│  Phase 0:  ┌────────────┐    Phase 1:  ┌──────┐    Phase 2:  ┌────┐       │
│            │            │              │      │                │    │       │
│            │  128×128   │              │ 64×  │                │32× │       │
│            │            │              │  64  │                │ 32 │       │
│            │            │              │      │                │    │       │
│            └────────────┘              └──────┘                └────┘       │
│                                                                             │
│  Definition:                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ block_dims_expr = phase_dependent_tiles([                       │       │
│  │     [128, 128],    # Phase 0: Large blocks                     │       │
│  │     [64, 64],      # Phase 1: Medium blocks                    │       │
│  │     [32, 32],      # Phase 2: Small blocks                     │       │
│  │ ])                                                              │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  Rate Patterns:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ Input:  [2, 1, 1]  - Consume 2 blocks in phase 0               │       │
│  │ Output: [1, 1, 3]  - Produce 3 blocks in phase 2               │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  Execution Timeline:                                                        │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐           │
│  │ P0  │ P1  │ P2  │ P0  │ P1  │ P2  │ P0  │ P1  │ P2  │ ... │           │
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘           │
│    ▲     ▲     ▲                                                           │
│    │     │     │                                                           │
│    │     │     └── Small blocks, high output rate                          │
│    │     └──────── Medium blocks, processing                               │
│    └────────────── Large blocks, high input rate                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Performance Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Performance Metrics Calculation                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Interface Level Metrics                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 1. Calculate Block Volume                                        │       │
│  │    volume = ∏(block_dims)                                       │       │
│  │    e.g., [64, 32, 14, 14] → 401,408                            │       │
│  └──────────────────────┬──────────────────────────────────────────┘       │
│                         │                                                   │
│                         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 2. Apply Rate Pattern                                           │       │
│  │    effective_volume = volume × rate_pattern[phase]              │       │
│  │    e.g., 401,408 × 2 = 802,816 (phase 0, rate=2)              │       │
│  └──────────────────────┬──────────────────────────────────────────┘       │
│                         │                                                   │
│                         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 3. Calculate Bandwidth                                          │       │
│  │    bandwidth_bits = effective_volume × dtype.bitwidth           │       │
│  │    bandwidth_mbps = bandwidth_bits / 1e6 / period_seconds       │       │
│  │    e.g., 802,816 × 8 bits / 1e6 / 0.001s = 6,422 Mbps         │       │
│  └──────────────────────┬──────────────────────────────────────────┘       │
│                         │                                                   │
│                         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 4. Calculate Initiation Interval                                │       │
│  │    total_blocks = ∏(tensor_dims ÷ block_dims)                  │       │
│  │    ii = total_blocks ÷ iPar                                    │       │
│  │    e.g., 8,192 blocks ÷ 16 parallel = 512 cycles              │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  Kernel Level Aggregation                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ • total_bandwidth = Σ(interface_bandwidths)                     │       │
│  │ • initiation_interval = max(interface_iis)                      │       │
│  │ • interface_parallelisms = {name: iPar for each interface}      │       │
│  └─────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Validation Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Validation Workflow                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Model Creation                                                             │
│  ┌──────────────┐                                                          │
│  │create_model()│                                                          │
│  └──────┬───────┘                                                          │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 1. Dimension Validation                                         │       │
│  │    • Check tensor_dims match expected count                    │       │
│  │    • Verify positive dimensions                                │       │
│  │    • Validate against constraints                              │       │
│  └──────┬──────────────────────────────────────────────────────────┘       │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 2. Block Dimension Derivation                                   │       │
│  │    • Evaluate expressions                                       │       │
│  │    • Call tiling functions                                     │       │
│  │    • Apply defaults if needed                                  │       │
│  └──────┬──────────────────────────────────────────────────────────┘       │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 3. Granularity Check                                           │       │
│  │    • Verify block dims respect granularity                     │       │
│  │    • e.g., dim % granularity[i] == 0                          │       │
│  └──────┬──────────────────────────────────────────────────────────┘       │
│         │                                                                   │
│         ▼                                                                   │
│  Kernel Model Creation                                                      │
│  ┌──────────────┐                                                          │
│  │ KernelModel()│                                                          │
│  └──────┬───────┘                                                          │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 4. Relationship Validation                                      │       │
│  │    • Check all relationships satisfied                          │       │
│  │    • Verify dimension compatibility                            │       │
│  │    • Validate iPar propagation rules                          │       │
│  └──────┬──────────────────────────────────────────────────────────┘       │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ 5. Performance Validation                                       │       │
│  │    • Check iPar ≤ block dimensions                            │       │
│  │    • Verify factorization possible                            │       │
│  │    • Validate performance metrics                             │       │
│  └──────┬──────────────────────────────────────────────────────────┘       │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────┐                                                          │
│  │ Valid Model  │                                                          │
│  └──────────────┘                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Common Usage Patterns

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Common Usage Patterns                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. CNN Layer Pattern                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ Input:  channel_major_tiling(32, "tile")  → [1, 32, 14, 14]    │       │
│  │ Weight: channel_major_tiling(32, "full")  → [32, 32, 3, 3]     │       │
│  │ Output: channel_major_tiling(32, "tile")  → [1, 32, 14, 14]    │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  2. Matrix Multiply Pattern                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ A: parameterized_tiles("M", "K")  → [64, 32]                   │       │
│  │ B: parameterized_tiles("K", "N")  → [32, 128]                  │       │
│  │ C: parameterized_tiles("M", "N")  → [64, 128]                  │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  3. Memory-Optimized Pattern                                                │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ Large: memory_constrained_tiles(1MB, 4)  → [64, 64, 16, 16]    │       │
│  │ Small: power_of_two_tiles(16, 256)       → [128, 256, 32, 32]  │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  4. Adaptive DSE Pattern                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │ composite_tiling(                                               │       │
│  │   adaptive_tiles("dse_config"),                                │       │
│  │   parameterized_tiles("TILE"),                                 │       │
│  │   fixed_tiles(32, 32)  # fallback                              │       │
│  │ )                                                               │       │
│  └─────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```