version: "3.0"
name: "BERT Legacy"
description: "Blueprint that replicates old_bert.py functionality using Legacy FINN backend with full parity"

hw_compiler:
  # Legacy FINN backend only uses build_steps, not kernels/transforms
  kernels: []
  transforms: {}
      
  build_steps:
    # Full parity with old BUILD_BERT_STEPS (except loop operations)
    # Step 1-2: Cleanup operations
    - "cleanup"  # RemoveIdentityOps, SortCommutativeInputsInitializerLast, etc.
    - "cleanup_advanced"  # GiveUniqueNodeNames, GiveReadableTensorNames, etc.
    
    # Step 3-4: BERT-specific model modifications
    - "remove_head"  # Remove nodes up to first LayerNorm
    - "remove_tail"  # Remove from global_out_1 back to LayerNorm
    
    # Step 5: QONNX to FINN conversion with SoftMax handling
    - "qonnx_to_finn"  # ExpandNorms, FoldConstants, ConvertDivToMul, ConvertQONNXtoFINN
    
    # Step 6: Comprehensive streamlining (now with full parity)
    - "streamlining"  # All absorptions, moves, CollapseRepeatedMul, SortGraph
    
    # Step 7: Hardware inference (now with full parity)
    - "infer_hardware"  # SpecializeLayers + all 7 infer transforms
    
    # Step 8-9: FINN standard steps
    - "step_create_dataflow_partition"
    - "step_specialize_layers"
    
    # Steps 10-11: Loop operations NOT AVAILABLE
    # - "custom_step_extract_loop_body"  # Loop-specific optimization
    # - "custom_step_loop_rolling"  # Loop-specific optimization
    
    # Steps 12-14: Optimization and folding
    - "step_target_fps_parallelization"
    - "step_apply_folding_config"
    - "constrain_folding_and_set_pumped_compute"  # TempShuffleFixer + SetPumpedCompute
    
    # Steps 15-21: Backend compilation and IP generation
    - "step_minimize_bit_width"
    - "step_generate_estimate_reports"
    - "step_hw_codegen"
    - "step_hw_ipgen"
    - "step_measure_rtlsim_performance"
    - "step_set_fifo_depths"
    - "step_create_stitched_ip"
    
    # Step 22: Shell integration metadata
    - "shell_metadata_handover"  # ExtractShellIntegrationMetadata
    
  config_flags:
    # Configuration from old system
    board: "Pynq-Z1"
    clock_period_ns: 10.0
    shell_flow_type: "vivado_zynq"
    auto_fifo_depths: true
    minimize_bit_width: true
    preserve_intermediate_models: true
    pumped_compute: true  # SetPumpedCompute attribute
    
processing:
  # No preprocessing/postprocessing in old system
  preprocessing: []
  postprocessing: []

search:
  # Single configuration like old system
  strategy: "exhaustive"
  constraints: []
  
global:
  # Match old system outputs
  output_stage: "stitched_ip"
  working_directory: "./bert_legacy_output"
  save_artifacts: true
  log_level: "DEBUG"