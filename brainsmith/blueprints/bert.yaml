version: "3.0"
name: "BERT Accelerator"
description: "Blueprint for BERT model acceleration with custom optimizations"

hw_compiler:
  kernels:
    # Core compute kernels
    - ["MatrixVectorUnit", ["rtl"]]
    - ["LayerNorm", ["hls"]]
    - ["Softmax", ["hls", "rtl"]]
    - ["Shuffle", ["hls"]]
    
    # Support kernels
    - ["ElementwiseBinary", ["hls"]]
    - ["DuplicateStreams", ["hls"]]
    - ["Thresholding", ["hls"]]
    
  transforms:
    # Using standardized stage names for BERT-specific flow
    cleanup:
      # Graph cleanup and preparation
      - "SortCommutativeInputsInitializerLast"
      - "RemoveIdentityOps"
      - "RemoveUnusedTensors"
      - "GiveReadableTensorNames"
      - "GiveUniqueNodeNames"
      
    topology_opt:
      # QONNX to FINN conversion with BERT-specific handling
      - "ExpandNorms"
      - "FoldConstants"
      - "ConvertDivToMul"
      - "ConvertQONNXtoFINN"
      
      # Streamlining and absorption transformations
      - "AbsorbSignBiasIntoMultiThreshold"
      - "AbsorbAddIntoMultiThreshold"
      - "AbsorbMulIntoMultiThreshold"
      - "RoundAndClipThresholds"
      - "MoveOpPastFork"
      - "MoveScalarMulPastMatMul"
      - "MoveScalarLinearPastInvariants"
      
    # Note: Hardware inference transforms (InferLayerNorm, InferShuffle, etc.) 
    # are automatically applied here based on the kernel list
      
    kernel_opt:
      # BERT-specific kernel optimizations
      - "TempShuffleFixer"
      - "SetPumpedCompute"
      
  build_steps:
    # Using registered step names (not legacy custom_step_* names)
    # === Cleanup and graph surgery ===
    - "cleanup"
    - "remove_head"
    - "remove_tail"
    - "qonnx_to_finn"
    
    # === Core processing ===
    - "generate_reference_io"
    - "topology_opt"
    - "infer_hardware"
    
    # === Standard FINN pipeline ===
    - "create_dataflow_partition"
    - "specialize_layers"
    - "target_fps_parallelization"
    - "apply_folding_config"
    - "minimize_bit_width"
    - "generate_estimate_reports"
    - "hw_codegen"
    - "hw_ipgen"
    - "measure_rtlsim_performance"
    - "set_fifo_depths"
    - "create_stitched_ip"
    
    # === Final post_proc ===
    - "shell_post_proc_handover"
    
  config_flags:
    # Hardware-specific settings for DSE v3
    target_device: "xczu7ev-ffvc1156-2-e"
    target_clock_ns: 3.33

# FINN configuration (used by both legacy and DSE v3 backends)
finn_config:
  # BERT-specific hardware settings
  standalone_thresholds: true
  board: "V80" 
  clock_period_ns: 3.33
  auto_fifo_depths: true
  minimize_bit_width: true
  split_large_fifos: true
  
  # Verification settings
  verification_atol: 0.1
  fifosim_n_inferences: 2
  save_intermediate_models: true
  
  # BERT-specific flags
  enable_pumpedCompute: true
  shell_flow_type: "vivado_zynq"

processing:
  # BERT requires custom preprocessing steps handled by build_steps
  preprocessing: []
  postprocessing: []

search:
  # Single build configuration for BERT (no DSE)
  strategy: "exhaustive"
  constraints: []

global:
  # Target complete IP generation
  output_stage: "stitched_ip"
  enable_profiling: false
  working_directory: "./bert_builds"