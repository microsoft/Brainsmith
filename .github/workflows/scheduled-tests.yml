name: Scheduled Tests

on:
  schedule:
    - cron: '0 0 * * 1'  # Monday at 00:00 UTC
    - cron: '0 0 * * 4'  # Thursday at 00:00 UTC

env:
  DOCKER_BUILDKIT: 1
  BSMITH_DOCKER_PREBUILT: "0"
  BSMITH_DOCKER_NO_CACHE: "1"
  BSMITH_SKIP_DEP_REPOS: "0"
  BSMITH_XILINX_VERSION: ${{ vars.BSMITH_XILINX_VERSION }}
  BSMITH_XILINX_PATH: ${{ vars.BSMITH_XILINX_PATH }}
  NUM_DEFAULT_WORKERS: ${{ vars.NUM_DEFAULT_WORKERS }}
  BSMITH_DOCKER_TAG: "microsoft/brainsmith:scheduled-${{ github.sha }}"
  BSMITH_DOCKER_FLAGS: "-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }} --label ci-run=${{ github.run_id }}"

permissions:
  contents: read
  packages: write

jobs:
  # Environment validation and setup
  validate-environment:
    runs-on: pre-release
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check disk space
        uses: ./.github/actions/check-disk

      - name: Clean Docker resources
        uses: ./.github/actions/docker-cleanup

      - name: Validate environment
        run: |
          echo "=== System Information ==="
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "Available Disk Space: $(df -h / | tail -1 | awk '{print $4}')"
          echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
          
          echo "=== Docker Information ==="
          docker --version
          docker info --format "{{.ServerVersion}}" 2>/dev/null || echo "Docker info failed"
          
          echo "=== Git Information ==="
          git log --oneline -3
          echo "=== Validation Complete ==="

  # Build and test - all comprehensive tests
  comprehensive-test-suite:
    uses: ./.github/workflows/build-and-test.yml
    needs: validate-environment
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}

  # Full unit test suite using existing image
  full-unit-tests:
    uses: ./.github/workflows/run-test.yml
    needs: comprehensive-test-suite
    with:
      test-name: "Full Unit Test Suite"
      test-type: "unit-tests"
      timeout-minutes: 240

  # BERT Large test using existing image  
  bert-large-biweekly:
    uses: ./.github/workflows/run-test.yml
    needs: comprehensive-test-suite
    with:
      test-name: "BERT Large"
      test-type: "e2e-bert"
      timeout-minutes: 1440

  # Final cleanup job - runs regardless of other job success/failure
  cleanup:
    if: always()
    needs: [validate-environment, comprehensive-test-suite, full-unit-tests, bert-large-biweekly]
    runs-on: pre-release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean Docker resources
        uses: ./.github/actions/docker-cleanup

      - name: Collect artifacts
        if: always()
        uses: ./.github/actions/collect-artifacts
        with:
          artifact-name: "scheduled-test-artifacts-${{ github.run_id }}"