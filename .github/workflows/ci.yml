name: Brainsmith CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  schedule:
    - cron: '0 0 * * 1'  # Monday at 00:00 UTC
    - cron: '0 0 * * 4'  # Thursday at 00:00 UTC

env:
  DOCKER_BUILDKIT: 1
  BSMITH_DOCKER_PREBUILT: "0"
  BSMITH_DOCKER_NO_CACHE: "1"
  BSMITH_SKIP_DEP_REPOS: "0"
  BSMITH_XILINX_VERSION: ${{ vars.BSMITH_XILINX_VERSION }}
  BSMITH_XILINX_PATH: ${{ vars.BSMITH_XILINX_PATH }}
  NUM_DEFAULT_WORKERS: ${{ vars.NUM_DEFAULT_WORKERS }}
  BSMITH_DOCKER_TAG: "microsoft/brainsmith:ci-${{ github.sha }}"
  GHCR_IMAGE: "ghcr.io/${{ github.repository_owner }}/brainsmith:ci-${{ github.sha }}"
  BSMITH_DOCKER_FLAGS: "-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }} --label ci-run=${{ github.run_id }}"

permissions:
  contents: read
  packages: write

jobs:
  # Environment validation and setup
  validate-environment:
    runs-on: pre-release
    timeout-minutes: 10
    outputs:
      container-name: ${{ steps.env-check.outputs.container-name }}
      docker-tag: ${{ steps.env-check.outputs.docker-tag }}
    steps:
      - uses: ./.github/actions/setup-and-test
        with:
          check-disk: 'false'  # We'll check it manually in the validation
          pull-image: 'false'  # No image to pull yet

      - name: Validate environment and generate outputs
        id: env-check
        run: |
          echo "=== System Information ==="
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "Working Directory: $(pwd)"
          echo "Available Disk Space: $(df -h / | tail -1 | awk '{print $4}')"
          echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
          
          echo "=== Docker Information ==="
          docker --version
          docker info --format "{{.ServerVersion}}" 2>/dev/null || echo "Docker info failed"
          
          echo "=== Git Information ==="
          git log --oneline -3
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "Commit: $COMMIT_HASH"
          
          echo "=== Environment Variables ==="
          env | grep -E '^(BSMITH_|GITHUB_|NUM_DEFAULT)' | sort
          
          echo "=== Container Name Generation ==="
          chmod +x smithy
          CONTAINER_NAME="brainsmith_dev_$(whoami)_$(echo "$(pwd)" | md5sum | cut -d' ' -f1 | head -c 8)"
          echo "Expected container name: $CONTAINER_NAME"
          
          # Set outputs for other jobs
          echo "container-name=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          echo "docker-tag=$BSMITH_DOCKER_TAG" >> $GITHUB_OUTPUT
          
          echo "=== Validation Complete ==="

  # Docker image build and basic functionality test
  docker-build-and-test:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 60
    needs: validate-environment
    steps:
      - uses: ./.github/actions/setup-and-test
        with:
          pull-image: 'false'  # We're building the image, not pulling it
          docker-cleanup: 'true'

      - name: Build and verify image
        run: .github/scripts/ci-common.sh build-verify
      
      - name: Test container functionality
        run: |
          .github/scripts/ci-common.sh smithy-test \
            "Basic Functionality" \
            "echo 'Container test: SUCCESS' && python --version && ls -la \$BSMITH_DIR | head -10" \
            5
          
      - name: Login to GHCR
        if: success()
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
      - name: Push to GHCR
        if: success()
        run: .github/scripts/ci-common.sh push-ghcr
      
      - name: Upload digest
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: image-digest
          path: /tmp/image-digest.txt
          retention-days: 1

      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs-${{ github.run_id }}
          path: |
            /tmp/brainsmith*
            ~/.docker/
          retention-days: 3

      - name: Cleanup
        if: always()
        run: |
          ./smithy cleanup || true
          docker container prune -f

  # End-to-end test with dependency fetching and compilation
  e2e-test:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 120
    needs: [validate-environment, docker-build-and-test]
    
    steps:
      - uses: ./.github/actions/setup-and-test
      
      - name: Download digest
        uses: actions/download-artifact@v4
        with:
          name: image-digest
          path: /tmp/
      
      - name: Run E2E test
        run: |
          .github/scripts/ci-common.sh smithy-test \
            "E2E BERT" \
            "cd demos/bert && make clean && make" \
            30

      - name: Collect artifacts
        if: always()
        run: .github/scripts/ci-common.sh collect-artifacts artifacts

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts-${{ github.run_id }}
          path: artifacts/
          retention-days: 7

  # Full pytest suite (only on schedule to save resources)
  full-test-suite:
    if: github.event_name == 'schedule'
    runs-on: pre-release
    timeout-minutes: 240
    needs: [validate-environment, docker-build-and-test, e2e-test]  # Run after e2e-test passes
    
    steps:
      - uses: ./.github/actions/setup-and-test
      
      - name: Download digest
        uses: actions/download-artifact@v4
        with:
          name: image-digest
          path: /tmp/
      
      - name: Run full test suite
        run: |
          .github/scripts/ci-common.sh smithy-test \
            "Full Test Suite" \
            "cd tests && timeout 180m pytest -v --tb=short ./" \
            180

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-results-${{ github.run_id }}
          path: |
            tests/
          retention-days: 14

  # BERT Large biweekly testing using smithy
  bert-large-biweekly:
    if: github.event_name == 'schedule' && (github.event.schedule == '0 0 * * 1' || github.event.schedule == '0 0 * * 4')
    runs-on: pre-release
    timeout-minutes: 1440 # 24-hour timeout for biweekly tests
    needs: [validate-environment, docker-build-and-test]

    steps:
      - uses: ./.github/actions/setup-and-test
      
      - name: Download digest
        uses: actions/download-artifact@v4
        with:
          name: image-digest
          path: /tmp/
      
      - name: Run BERT Large test
        run: |
          .github/scripts/ci-common.sh smithy-test \
            "BERT Large" \
            "cd demos/bert && make bert_large_single_layer" \
            1440
        env:
          BSMITH_DOCKER_FLAGS: "-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }}"

  # Final cleanup job - runs regardless of other job success/failure
  cleanup:
    if: always()
    needs: [validate-environment]  # Only depend on first job
    runs-on: pre-release
    steps:
      - name: Smart cleanup based on completed jobs
        run: |
          echo "=== Checking for containers to clean ==="
          
          # Clean any brainsmith containers
          CONTAINERS=$(docker ps -a --filter "name=brainsmith" --format "{{.Names}}")
          if [ -n "$CONTAINERS" ]; then
            echo "Found containers to clean: $CONTAINERS"
            docker rm -f $CONTAINERS || true
          fi
          
          # Prune with label filter for safety
          docker container prune -f --filter "label=ci-run=${{ github.run_id }}" || true
          docker image prune -f --filter "label=ci-run=${{ github.run_id }}" || true
          
          # General cleanup
          docker system prune -f --volumes || true
          
          # Clean up workspace files (GitHub Actions handles this automatically)
          rm -rf ${{ github.workspace }}/* 2>/dev/null || true
          rm -rf ${{ github.workspace }}/.* 2>/dev/null || true
          
          echo "Cleanup completed"
