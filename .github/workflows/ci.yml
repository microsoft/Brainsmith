name: Brainsmith CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  schedule:
    - cron: '0 0 * * 0'  # Sunday at 00:00 UTC

env:
  DOCKER_BUILDKIT: 1
  BSMITH_DOCKER_PREBUILT: "0"
  BSMITH_DOCKER_NO_CACHE: "1"
  BSMITH_SKIP_DEP_REPOS: "0"
  BSMITH_XILINX_VERSION: ${{ vars.BSMITH_XILINX_VERSION || '2024.2' }}
  BSMITH_XILINX_PATH: ${{ vars.BSMITH_XILINX_PATH || '/opt/Xilinx' }}
  NUM_DEFAULT_WORKERS: ${{ vars.NUM_DEFAULT_WORKERS || '4' }}
  # Use predictable Docker tag to avoid git describe issues
  BSMITH_DOCKER_TAG: "microsoft/brainsmith:ci-${{ github.sha }}"

jobs:
  # Simple diagnostic job to understand the environment
  diagnostics:
    runs-on: pre-release
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Environment diagnostics
        run: |
          echo "=== System Information ==="
          uname -a
          echo
          echo "=== Disk Space ==="
          df -h
          echo
          echo "=== Memory ==="
          free -h
          echo
          echo "=== Docker Version ==="
          docker --version
          docker info | head -20
          echo
          echo "=== Git Information ==="
          pwd
          git status
          git log --oneline -5
          echo
          echo "=== Git Describe Test ==="
          git describe --always --tags --dirty 2>&1 || echo "git describe failed"
          git rev-parse --short HEAD 2>&1 || echo "git rev-parse failed"
          echo
          echo "=== Environment Variables ==="
          env | grep BSMITH || true
          env | grep GITHUB || true
          echo
          echo "=== brainsmith-container script test ==="
          chmod +x brainsmith-container
          echo "Testing Docker tag generation..."
          export BSMITH_DOCKER_TAG=""  # Clear to test auto-generation
          ./brainsmith-container help

  docker-build:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 60  # Increased from 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup and debug environment
        run: |
          echo "=== Pre-build Environment ==="
          echo "BSMITH_DOCKER_TAG: $BSMITH_DOCKER_TAG"
          echo "Working directory: $(pwd)"
          echo "Available space:"
          df -h
          
          # Cleanup to free space
          sudo docker system prune -af
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          
          echo "Space after cleanup:"
          df -h

      - name: Build Docker image with debug
        run: |
          chmod +x brainsmith-container
          echo "=== Starting Docker build ==="
          echo "Using Docker tag: $BSMITH_DOCKER_TAG"
          
          # Export the tag so brainsmith-container uses it
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          
          # Run with debug output
          ./brainsmith-container build

      - name: Test basic container functionality
        run: |
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          export BSMITH_DOCKER_RUN_AS_ROOT="1"
          
          echo "=== Testing container startup ==="
          ./brainsmith-container start daemon
          
          echo "=== Testing container status ==="
          ./brainsmith-container status
          
          echo "=== Testing basic commands ==="
          ./brainsmith-container exec "echo 'Container is working'"
          ./brainsmith-container exec "python --version"
          ./brainsmith-container exec "pwd"
          ./brainsmith-container exec "ls -la"
          
          echo "=== Testing dependency directory ==="
          ./brainsmith-container exec "ls -la deps/ || echo 'Dependencies directory not found'"
          
          echo "=== Stopping container ==="
          ./brainsmith-container stop

      - name: Upload Docker build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs
          path: |
            /tmp/brainsmith*
          retention-days: 7

      - name: Cleanup containers
        if: always()
        run: |
          ./brainsmith-container cleanup || true

  # Simplified end-to-end test focused on finding where it fails
  e2e-test:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 120  # Reduced to 2 hours for faster feedback
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "=== Environment Setup ==="
          sudo docker system prune -af
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          df -h
          
          echo "=== DEBUG: Initial environment state ==="
          echo "Working directory: $(pwd)"
          echo "User: $(whoami)"
          echo "Groups: $(groups)"
          echo "Home: $HOME"
          echo "Current directory contents:"
          ls -la
          echo "Docker info:"
          docker info | head -20
          echo "Available containers:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}" | head -10

      - name: Build and start container
        run: |
          chmod +x brainsmith-container
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          export BSMITH_DOCKER_FLAGS="-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }}"
          export BSMITH_DOCKER_RUN_AS_ROOT="1"
          
          echo "=== DEBUG: Environment variables ==="
          echo "BSMITH_DOCKER_TAG: $BSMITH_DOCKER_TAG"
          echo "BSMITH_DIR: $(pwd)"
          echo "USER: $(whoami)"
          echo "Working directory: $(pwd)"
          echo "Directory hash: $(echo "$(pwd)" | md5sum | cut -d' ' -f1 | head -c 8)"
          echo "Expected container name: brainsmith_dev_$(whoami)_$(echo "$(pwd)" | md5sum | cut -d' ' -f1 | head -c 8)"
          
          echo "=== Building container ==="
          ./brainsmith-container build
          
          echo "=== DEBUG: Container name generation test ==="
          ./brainsmith-container status || echo "Status command failed"
          
          echo "=== Starting container ==="
          ./brainsmith-container start daemon
          START_EXIT_CODE=$?
          echo "Container start exit code: $START_EXIT_CODE"
          
          echo "=== DEBUG: All containers after start ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Command}}" | head -10
          
          echo "=== Verifying container ==="
          ./brainsmith-container status
          STATUS_EXIT_CODE=$?
          echo "Status check exit code: $STATUS_EXIT_CODE"
          
          echo "=== DEBUG: Container inspection ==="
          CONTAINER_NAME="brainsmith_dev_$(whoami)_$(echo "$(pwd)" | md5sum | cut -d' ' -f1 | head -c 8)"
          echo "Looking for container: $CONTAINER_NAME"
          docker inspect "$CONTAINER_NAME" --format "{{.State.Status}}" 2>/dev/null || echo "Container not found by direct name"
          
          echo "=== Container name debugging ==="
          echo "Expected container name should contain: brainsmith_dev_"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep brainsmith || echo "No brainsmith containers found"
          docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep brainsmith || echo "No brainsmith containers found (including stopped)"

      - name: Test dependency fetching
        run: |
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          
          echo "=== DEBUG: Pre-exec container verification ==="
          ./brainsmith-container status
          docker ps --filter "name=brainsmith" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "=== DEBUG: Container logs before exec ==="
          ./brainsmith-container logs --tail 10 || echo "No logs available"
          
          echo "=== Testing dependency fetch ==="
          echo "Current directory: $(pwd)"
          echo "BSMITH_DIR should be: $(pwd)"
          
          echo "=== DEBUG: Testing simple exec first ==="
          ./brainsmith-container exec "echo 'Simple exec test successful'" || {
            echo "ERROR: Simple exec failed!"
            echo "=== Container status after failed exec ==="
            ./brainsmith-container status
            echo "=== All containers ==="
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Command}}"
            echo "=== Container logs ==="
            ./brainsmith-container logs --tail 20
            exit 1
          }
          
          # Test the fetch script directly first
          ./brainsmith-container exec "echo 'Testing environment variables:'"
          ./brainsmith-container exec "echo BSMITH_DIR=\$BSMITH_DIR"
          ./brainsmith-container exec "echo BSMITH_BUILD_DIR=\$BSMITH_BUILD_DIR"
          ./brainsmith-container exec "echo BSMITH_SKIP_DEP_REPOS=\$BSMITH_SKIP_DEP_REPOS"
          
          echo "=== Testing basic fetch ==="
          ./brainsmith-container exec "cd \$BSMITH_DIR && pwd && ls -la"
          
          echo "=== Running dependency fetch ==="
          ./brainsmith-container exec "cd \$BSMITH_DIR && timeout 30m source docker/fetch-repos.sh" || {
            echo "Dependency fetch failed or timed out"
            echo "=== Container logs ==="
            ./brainsmith-container logs --tail 50
            exit 1
          }

      - name: Verify dependencies
        run: |
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          
          echo "=== Checking fetched dependencies ==="
          ./brainsmith-container exec "ls -la \$BSMITH_DIR/deps/ || echo 'No deps directory'"
          ./brainsmith-container exec "find \$BSMITH_DIR/deps -maxdepth 2 -type d | head -20 || true"

      - name: Test simple BERT compilation
        run: |
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          
          echo "=== Testing BERT demo directory ==="
          ./brainsmith-container exec "ls -la demos/bert/"
          
          echo "=== Testing BERT compilation (limited time) ==="
          timeout 30m ./brainsmith-container exec "cd demos/bert && make clean && make" || {
            echo "BERT compilation failed or timed out after 30 minutes"
            echo "=== Checking what was generated ==="
            ./brainsmith-container exec "find demos/bert -newer demos/bert/Makefile | head -20 || true"
            echo "=== Container logs ==="
            ./brainsmith-container logs --tail 100
            exit 1
          }

      - name: Collect detailed artifacts
        if: always()
        run: |
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          mkdir -p artifacts
          
          echo "=== Collecting artifacts ==="
          
          # System information
          df -h > artifacts/disk_usage.txt
          free -h > artifacts/memory_usage.txt
          
          # Container logs
          ./brainsmith-container logs > artifacts/container.log 2>&1 || true
          
          # Container state
          ./brainsmith-container status > artifacts/container_status.txt 2>&1 || true
          
          # Directory contents
          ./brainsmith-container exec "find \$BSMITH_DIR/deps -type d | head -50" > artifacts/deps_dirs.txt 2>&1 || true
          ./brainsmith-container exec "find demos/bert -type f | head -50" > artifacts/bert_files.txt 2>&1 || true
          
          # Python environment
          ./brainsmith-container exec "python -c 'import sys; print(sys.path)'" > artifacts/python_path.txt 2>&1 || true
          ./brainsmith-container exec "pip list" > artifacts/pip_list.txt 2>&1 || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: artifacts/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          ./brainsmith-container stop || true
          ./brainsmith-container cleanup || true

  # Only run full tests on schedule
  pytest-fpgadataflow:
    if: github.event_name == 'schedule'
    runs-on: pre-release
    timeout-minutes: 240
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Run full test suite
        run: |
          chmod +x brainsmith-container
          export BSMITH_DOCKER_TAG="$BSMITH_DOCKER_TAG"
          export BSMITH_DOCKER_FLAGS="-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }}"
          
          ./brainsmith-container build
          ./brainsmith-container start daemon
          
          ./brainsmith-container exec "cd tests && timeout 180m pytest ./" || {
            echo "Tests failed or timed out"
            ./brainsmith-container logs --tail 50
            exit 1
          }
          
          ./brainsmith-container stop

      - name: Cleanup
        if: always()
        run: |
          ./brainsmith-container cleanup || true
