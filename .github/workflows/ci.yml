name: Brainsmith CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  schedule:
    - cron: '0 0 * * 0'  # Sunday at 00:00 UTC

env:
  DOCKER_BUILDKIT: 1
  BSMITH_DOCKER_PREBUILT: "0"
  BSMITH_DOCKER_NO_CACHE: "1"
  BSMITH_SKIP_DEP_REPOS: "0"
  BSMITH_XILINX_VERSION: ${{ vars.BSMITH_XILINX_VERSION }}
  BSMITH_XILINX_PATH: ${{ vars.BSMITH_XILINX_PATH }}
  NUM_DEFAULT_WORKERS: ${{ vars.NUM_DEFAULT_WORKERS }}
  BSMITH_DOCKER_TAG: "microsoft/brainsmith:ci-${{ github.sha }}"
  BSMITH_DOCKER_FLAGS: "-e XILINXD_LICENSE_FILE=${{ secrets.XILINXD_LICENSE_FILE }}"

jobs:
  # Environment validation and setup
  validate-environment:
    runs-on: pre-release
    timeout-minutes: 10
    outputs:
      container-name: ${{ steps.env-check.outputs.container-name }}
      docker-tag: ${{ steps.env-check.outputs.docker-tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Validate environment and generate outputs
        id: env-check
        run: |
          echo "=== System Information ==="
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "Working Directory: $(pwd)"
          echo "Available Disk Space: $(df -h / | tail -1 | awk '{print $4}')"
          echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
          
          echo "=== Docker Information ==="
          docker --version
          docker info --format "{{.ServerVersion}}" 2>/dev/null || echo "Docker info failed"
          
          echo "=== Git Information ==="
          git log --oneline -3
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "Commit: $COMMIT_HASH"
          
          echo "=== Environment Variables ==="
          env | grep -E '^(BSMITH_|GITHUB_|NUM_DEFAULT)' | sort
          
          echo "=== Container Name Generation ==="
          chmod +x brainsmith-container
          CONTAINER_NAME="brainsmith_dev_$(whoami)_$(echo "$(pwd)" | md5sum | cut -d' ' -f1 | head -c 8)"
          echo "Expected container name: $CONTAINER_NAME"
          
          # Set outputs for other jobs
          echo "container-name=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          echo "docker-tag=$BSMITH_DOCKER_TAG" >> $GITHUB_OUTPUT
          
          echo "=== Validation Complete ==="

  # Docker image build and basic functionality test
  docker-build-and-test:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 60
    needs: validate-environment
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup and cleanup
        run: |
          echo "=== Pre-build cleanup ==="
          sudo docker system prune -af
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          echo "Available space: $(df -h / | tail -1 | awk '{print $4}')"

      - name: Build and test Docker image
        run: |
          chmod +x brainsmith-container
          echo "=== Building Docker image ==="
          echo "Using Docker tag: $BSMITH_DOCKER_TAG"
          
          ./brainsmith-container build
          
          echo "=== Testing basic container functionality ==="
          ./brainsmith-container start daemon
          
          # Quick functionality tests
          ./brainsmith-container exec "echo 'Container exec test: SUCCESS'"
          ./brainsmith-container exec "python --version"
          ./brainsmith-container exec "ls -la \$BSMITH_DIR | head -10"
          
          ./brainsmith-container stop

      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs-${{ github.run_id }}
          path: |
            /tmp/brainsmith*
            ~/.docker/
          retention-days: 3

      - name: Cleanup
        if: always()
        run: ./brainsmith-container cleanup || true

  # End-to-end test with dependency fetching and compilation
  e2e-test:
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'
    runs-on: pre-release
    timeout-minutes: 120
    needs: validate-environment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "=== Environment Setup ==="
          sudo docker system prune -af
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          
          echo "=== Environment Debug Info ==="
          echo "Working directory: $(pwd)"
          echo "User: $(whoami)"
          echo "Expected container: ${{ needs.validate-environment.outputs.container-name }}"
          echo "Available space: $(df -h / | tail -1 | awk '{print $4}')"

      - name: Build and start container with comprehensive logging
        run: |
          chmod +x brainsmith-container
          
          echo "=== Building container ==="
          ./brainsmith-container build || {
            echo "ERROR: Container build failed"
            docker images | grep brainsmith || echo "No brainsmith images found"
            exit 1
          }
          
          echo "=== Starting daemon container ==="
          ./brainsmith-container start daemon || {
            echo "ERROR: Container start failed"
            echo "=== Container status ==="
            ./brainsmith-container status
            echo "=== Docker containers ==="
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Command}}" | head -10
            exit 1
          }
          
          echo "=== Verifying container readiness ==="
          ./brainsmith-container status
          docker ps --filter "name=brainsmith" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Test core functionality
        run: |
          echo "=== Testing basic exec functionality ==="
          ./brainsmith-container exec "echo 'Exec test: SUCCESS'" || {
            echo "ERROR: Basic exec failed"
            ./brainsmith-container status
            ./brainsmith-container logs --tail 20
            exit 1
          }
          
          echo "=== Environment verification ==="
          ./brainsmith-container exec "echo \"BSMITH_DIR=\$BSMITH_DIR\""
          ./brainsmith-container exec "echo \"BSMITH_BUILD_DIR=\$BSMITH_BUILD_DIR\""
          ./brainsmith-container exec "echo \"BSMITH_SKIP_DEP_REPOS=\$BSMITH_SKIP_DEP_REPOS\""
          
          echo "=== Python environment check ==="
          ./brainsmith-container exec "python --version && which python"

      - name: Test dependency fetching and setup
        run: |
          echo "=== Running dependency fetch ==="
          ./brainsmith-container exec "cd \$BSMITH_DIR && echo 'Starting dependency fetch...' && timeout 30m source docker/fetch-repos.sh" || {
            echo "ERROR: Dependency fetch failed or timed out"
            echo "=== Container status ==="
            ./brainsmith-container status
            echo "=== Container logs (last 50 lines) ==="
            ./brainsmith-container logs --tail 50
            exit 1
          }
          
          echo "=== Verifying dependencies ==="
          ./brainsmith-container exec "ls -la \$BSMITH_DIR/deps/ | head -20"
          ./brainsmith-container exec "find \$BSMITH_DIR/deps -maxdepth 2 -type d | wc -l"

      - name: Test compilation workflow
        run: |
          echo "=== Testing BERT compilation ==="
          ./brainsmith-container exec "ls -la demos/bert/"
          
          timeout 30m ./brainsmith-container exec "cd demos/bert && make clean && make" || {
            echo "WARNING: BERT compilation failed or timed out (this may be expected in CI)"
            echo "=== Checking generated files ==="
            ./brainsmith-container exec "find demos/bert -newer demos/bert/Makefile | head -20 || true"
          }

      - name: Collect artifacts and debug info
        if: always()
        run: |
          mkdir -p artifacts
          
          echo "=== Collecting system info ==="
          df -h > artifacts/disk_usage.txt
          free -h > artifacts/memory_usage.txt
          
          echo "=== Collecting container info ==="
          ./brainsmith-container status > artifacts/container_status.txt 2>&1 || echo "Status failed" > artifacts/container_status.txt
          ./brainsmith-container logs > artifacts/container.log 2>&1 || echo "No logs" > artifacts/container.log
          
          echo "=== Collecting environment info ==="
          ./brainsmith-container exec "find \$BSMITH_DIR/deps -type d | head -50" > artifacts/deps_dirs.txt 2>&1 || true
          ./brainsmith-container exec "pip list" > artifacts/pip_list.txt 2>&1 || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts-${{ github.run_id }}
          path: artifacts/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          ./brainsmith-container stop || true
          ./brainsmith-container cleanup || true

  # Full pytest suite (only on schedule to save resources)
  full-test-suite:
    if: github.event_name == 'schedule'
    runs-on: pre-release
    timeout-minutes: 240
    needs: [validate-environment, e2e-test]  # Run after e2e-test passes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build container and run comprehensive tests
        run: |
          chmod +x brainsmith-container
          
          echo "=== Building container for full test suite ==="
          ./brainsmith-container build
          
          echo "=== Starting container for testing ==="
          ./brainsmith-container start daemon
          
          echo "=== Running full pytest suite ==="
          ./brainsmith-container exec "cd tests && timeout 180m pytest -v --tb=short ./" || {
            echo "ERROR: Full test suite failed or timed out"
            echo "=== Container logs ==="
            ./brainsmith-container logs --tail 100
            exit 1
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-results-${{ github.run_id }}
          path: |
            tests/
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          ./brainsmith-container stop || true
          ./brainsmith-container cleanup || true
