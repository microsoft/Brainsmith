version: "3.0"
name: "BERT Modern Demo"
description: "Modern BERT implementation with exact parity to old system using Legacy FINN Backend"

hw_compiler:
  # Legacy FINN backend only uses build_steps, not kernels/transforms
  kernels: []
  transforms: {}
  
  # All 22 build steps from original bert.py (excluding loop operations)
  build_steps:
    # Step 1-2: Cleanup operations
    - "cleanup"  # RemoveIdentityOps, SortCommutativeInputsInitializerLast
    - "cleanup_advanced"  # GiveUniqueNodeNames, GiveReadableTensorNames
    
    # Step 3-4: BERT-specific model modifications
    - "remove_head"  # Remove nodes up to first LayerNorm
    - "remove_tail"  # Remove from global_out_1 back to LayerNorm
    
    # Step 5: Fix dynamic dimensions (new step for robustness)
    - "fix_dynamic_dimensions"
    
    # Step 6: QONNX to FINN conversion with SoftMax handling
    - "qonnx_to_finn"  # ExpandNorms, FoldConstants, ConvertDivToMul, ConvertQONNXtoFINN
    
    # Step 7: Comprehensive streamlining
    - "streamlining"  # All absorptions, moves, reorders
    
    # Step 8: Apply folding constraints and pumped compute (MUST run before infer_hardware)
    - "constrain_folding_and_set_pumped_compute"  # TempShuffleFixer + SetPumpedCompute
    
    # Step 9: Hardware inference
    - "infer_hardware"  # All 7 infer transforms including custom ones
    
    # Step 10-11: FINN standard steps
    - "step_create_dataflow_partition"
    - "step_specialize_layers"
    
    # Step 12-13: Optimization and folding
    - "step_target_fps_parallelization"
    - "step_apply_folding_config"
    
    # Step 14-20: Backend compilation and IP generation
    - "step_minimize_bit_width"
    - "step_generate_estimate_reports"
    - "step_hw_codegen"
    - "step_hw_ipgen"
    - "step_measure_rtlsim_performance"
    - "step_set_fifo_depths"
    - "step_create_stitched_ip"
    
    # Step 21: Shell integration metadata
    - "shell_metadata_handover"  # ExtractShellIntegrationMetadata
    
  config_flags:
    # Board configuration (V80, Pynq-Z1, U250, etc.)
    board: "$BOARD"
    
    # Clock configuration
    clock_period_ns: $CLK_PERIOD
    
    # Shell flow type
    shell_flow_type: "$SHELL_TYPE"
    
    # Folding configuration file
    folding_config_file: "$FOLDING_CONFIG"
    
    # Target FPS for auto-folding
    target_fps: $TARGET_FPS
    
    # FIFO configuration
    auto_fifo_depths: $AUTO_FIFO
    fifosim_n_inferences: $FIFOSIM_N
    split_large_fifos: $SPLIT_FIFOS
    
    # Verification settings
    verification_atol: $VERIFICATION_ATOL
    
    # Other settings from old system
    standalone_thresholds: true
    minimize_bit_width: true
    preserve_intermediate_models: $SAVE_INTERMEDIATE
    pumped_compute: true
    
    # DCP generation
    stitched_ip_gen_dcp: $GEN_DCP
    
    # Stop at specific step (optional)
    stop_step: "$STOP_STEP"
    
    # Reference I/O paths
    verify_input_npy: "$WORKING_DIR/input.npy"
    verify_expected_output_npy: "$WORKING_DIR/expected_output.npy"
    verify_save_full_context: $SAVE_INTERMEDIATE
    
processing:
  # Generate reference I/O for verification
  preprocessing:
    - "generate_reference_io"
    
  postprocessing: []

search:
  # Single configuration like old system (no exploration)
  strategy: "exhaustive"
  constraints: []
  
global:
  # Match old system outputs
  output_stage: "stitched_ip"
  working_directory: "$WORKING_DIR"
  save_artifacts: true
  log_level: "$LOG_LEVEL"
  
  # Model configuration passed from demo script
  model_config:
    hidden_size: $HIDDEN_SIZE
    num_hidden_layers: $NUM_LAYERS
    num_attention_heads: $NUM_HEADS
    intermediate_size: $INTERMEDIATE_SIZE
    bitwidth: $BITWIDTH
    sequence_length: $SEQ_LEN